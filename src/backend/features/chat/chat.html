<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Oriole –ß–∞—Ç</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      background: #0078d4;
      color: white;
      padding: 1.2rem 2rem;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      user-select: none;
    }

    #status {
      text-align: center;
      background: #e1eaff;
      color: #004a99;
      font-size: 0.9rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #c3d3f5;
      user-select: none;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem 1.5rem;
      overflow: hidden;
      background: white;
      box-shadow: inset 0 0 10px #d4d9df;
      border-radius: 0 0 10px 10px;
      max-width: 700px;
      margin: 0 auto;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .message {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 20px;
      font-size: 1rem;
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      user-select: text;
      white-space: pre-wrap;
      margin-bottom: 14px;
      animation: fadeInUp 0.25s forwards;
      display: flex;
      flex-direction: column;
    }

    .message.sent {
      align-self: flex-end;
      background: #0078d4;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      align-self: flex-start;
      background: #f1f3f5;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message .user-id {
      font-size: 0.8rem;
      color: #999;
      margin-bottom: 4px;
      user-select: none;
    }

    .message .timestamp {
      display: block;
      margin-top: 6px;
      font-size: 0.85rem;
      color: #ffcc00;
      font-family: monospace;
      user-select: none;
      text-align: right;
    }

    footer {
      margin-top: 1rem;
      display: flex;
      gap: 0.75rem;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.85rem 1rem;
      font-size: 1rem;
      border: 2px solid #0078d4;
      border-radius: 30px;
      background: white;
    }

    button {
      background-color: #0078d4;
      border: none;
      border-radius: 30px;
      color: white;
      padding: 0 24px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

<header>Oriole –ß–∞—Ç</header>
<div id="status">üîå –û—Ç–∫–ª—é—á–µ–Ω–æ</div>

<div class="chat-container">
  <div id="messages" aria-live="polite" aria-relevant="additions"></div>

  <footer>
    <input type="text" id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
    <button id="sendBtn">‚û§</button>
  </footer>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const groupId = params.get("group_id");
  const userId = params.get("user_id");
  const connectionId = crypto.randomUUID();
  let socket;

  function formatTimestamp(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function addMessage(msg, cssClass) {
    const messages = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = `message ${cssClass}`;

    const userIdSpan = document.createElement("div");
    userIdSpan.className = "user-id";
    userIdSpan.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${msg.user_id}`;
    div.appendChild(userIdSpan);

    const textSpan = document.createElement("div");
    textSpan.textContent = msg.message;
    div.appendChild(textSpan);

    if (msg.timestamp) {
      const timeSpan = document.createElement("span");
      timeSpan.className = "timestamp";
      timeSpan.textContent = formatTimestamp(msg.timestamp);
      div.appendChild(timeSpan);
    }

    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function updateStatus(text) {
    document.getElementById("status").textContent = text;
  }

  function connect() {
    if (!groupId || !userId) {
      updateStatus("‚ùå –ù–µ —É–∫–∞–∑–∞–Ω group_id –∏–ª–∏ user_id");
      return;
    }

    socket = new WebSocket(`ws://127.0.0.1:8000/api/websocket/?group_id=${groupId}&user_id=${userId}`);

    socket.onopen = () => {
      updateStatus(`üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –≤ –≥—Ä—É–ø–ø–µ ${groupId}`);
      addMessage({ user_id: 0, message: "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", timestamp: null }, "received");
    };

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "history") {
          data.messages.forEach(msg => {
            const cssClass = msg.user_id == userId ? "sent" : "received";
            addMessage(msg, cssClass);
          });
        } else {
          const cssClass = data.user_id == userId ? "sent" : "received";
          addMessage(data, cssClass);
        }
      } catch {
        addMessage({ user_id: 0, message: "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è", timestamp: null }, "received");
      }
    };

    socket.onclose = () => {
      updateStatus("üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
      addMessage({ user_id: 0, message: "‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ", timestamp: null }, "received");
    };

    socket.onerror = () => {
      addMessage({ user_id: 0, message: "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", timestamp: null }, "received");
    };
  }

  function sendMessage() {
    const input = document.getElementById("input");
    const text = input.value.trim();
    if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;

    const message = {
      user_id: userId,
      connectionId,
      message: text
    };

    socket.send(JSON.stringify(message));
    input.value = "";
  }

  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  document.getElementById("input").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  window.onload = connect;
</script>

</body>
</html>
