<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Oriole –ß–∞—Ç</title>
  <style>
    /* --- –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –∏ –±–∞–∑–æ–≤–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ --- */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      background: #0078d4;
      color: white;
      padding: 1.2rem 2rem;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      user-select: none;
    }

    #status {
      text-align: center;
      background: #e1eaff;
      color: #004a99;
      font-size: 0.9rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #c3d3f5;
      user-select: none;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem 1.5rem;
      overflow: hidden;
      background: white;
      box-shadow: inset 0 0 10px #d4d9df;
      border-radius: 0 0 10px 10px;
      max-width: 700px;
      margin: 0 auto;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scrollbar-width: thin;
      scrollbar-color: #c3d3f5 transparent;
    }
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #a1b7e6;
      border-radius: 10px;
    }

    .message {
      max-width: 85%; /* —à–∏—Ä–µ */
      padding: 14px 18px; /* –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø—ã */
      border-radius: 20px;
      font-size: 1rem;
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      user-select: text;
      position: relative;
      white-space: pre-wrap;
      margin-bottom: 14px; /* –±–æ–ª—å—à–∏–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ */
    }

    .message.sent {
      align-self: flex-end;
      background: #0078d4;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      align-self: flex-start;
      background: #f1f3f5;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message .timestamp {
      position: absolute;
      bottom: 6px; /* –Ω–∏–∂–µ */
      right: 14px;
      font-size: 0.8rem; /* –∫—Ä—É–ø–Ω–µ–µ */
      opacity: 0.7; /* —è—Ä—á–µ */
      color: #666; /* –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–µ–µ */
      font-family: monospace;
      user-select: none;
    }

    footer {
      margin-top: 1rem;
      display: flex;
      gap: 0.75rem;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.85rem 1rem;
      font-size: 1rem;
      border: 2px solid #0078d4;
      border-radius: 30px;
      outline-offset: 2px;
      transition: border-color 0.3s;
      color: #333;
      background: white;
      box-shadow: 0 1px 3px rgb(0 120 212 / 0.3);
    }
    input[type="text"]:focus {
      border-color: #005a9e;
      box-shadow: 0 0 8px #005a9eaa;
    }

    button {
      background-color: #0078d4;
      border: none;
      border-radius: 30px;
      color: white;
      padding: 0 24px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 8px rgb(0 120 212 / 0.4);
      transition: background-color 0.3s, box-shadow 0.3s;
      user-select: none;
    }
    button:hover, button:focus {
      background-color: #005a9e;
      box-shadow: 0 6px 12px rgb(0 90 158 / 0.6);
      outline: none;
    }

    /* –õ–µ–≥–∫–∏–π –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
    .message {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeInUp 0.25s forwards;
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤ */
    @media (max-width: 480px) {
      .chat-container {
        padding: 1rem;
        border-radius: 0;
        max-width: 100%;
      }
      header {
        font-size: 1.4rem;
        padding: 1rem;
      }
      button {
        padding: 0 18px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

<header>Oriole –ß–∞—Ç</header>
<div id="status">üîå –û—Ç–∫–ª—é—á–µ–Ω–æ</div>

<div class="chat-container">
  <div id="messages" aria-live="polite" aria-relevant="additions"></div>

  <footer>
    <input type="text" id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" aria-label="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
    <button id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">‚û§</button>
  </footer>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const groupId = params.get("group_id");
  const userId = params.get("user_id");
  const connectionId = crypto.randomUUID();
  let socket;

  function formatTimestamp(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function formatMessage({ user_id, message, timestamp }) {
    return `${message}\n`; // –í—Ä–µ–º—è –ø–æ–∫–∞–∂–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ø–∞–Ω–æ–º
  }

  function addMessage(text, cssClass, timestamp) {
    const messages = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = `message ${cssClass}`;
    div.textContent = text;

    if (timestamp) {
      const timeSpan = document.createElement("span");
      timeSpan.className = "timestamp";
      timeSpan.textContent = formatTimestamp(timestamp);
      div.appendChild(timeSpan);
    }

    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function addSystemMessage(text) {
    addMessage(text, "received");
  }

  function updateStatus(text) {
    document.getElementById("status").textContent = text;
  }

  function connect() {
    if (!groupId || !userId) {
      updateStatus("‚ùå –ù–µ —É–∫–∞–∑–∞–Ω group_id –∏–ª–∏ user_id");
      return;
    }

    socket = new WebSocket(`ws://127.0.0.1:8000/api/websocket/?group_id=${groupId}&user_id=${userId}`);

    socket.onopen = () => {
      updateStatus(`üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –≤ –≥—Ä—É–ø–ø–µ ${groupId}`);
      addSystemMessage("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    };

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        if (data.type === "history") {
          data.messages.forEach(msg => {
            const cssClass = msg.user_id == userId ? "sent" : "received";
            addMessage(formatMessage(msg), cssClass, msg.timestamp);
          });
        } else {
          if (data.connectionId === connectionId) return;
          const cssClass = data.user_id == userId ? "sent" : "received";
          addMessage(formatMessage(data), cssClass, data.timestamp);
        }
      } catch {
        addSystemMessage("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
      }
    };

    socket.onclose = () => {
      updateStatus("üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
      addSystemMessage("‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ");
    };

    socket.onerror = () => {
      addSystemMessage("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
    };
  }

  function sendMessage() {
    const input = document.getElementById("input");
    const text = input.value.trim();
    if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;

    const message = {
      user_id: userId,
      connectionId,
      message: text
    };

    socket.send(JSON.stringify(message));
    addMessage(formatMessage(message), "sent", new Date().toISOString());
    input.value = "";
  }

  document.getElementById("sendBtn").addEventListener("click", sendMessage);

  document.getElementById("input").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  window.onload = connect;
</script>

</body>
</html>
