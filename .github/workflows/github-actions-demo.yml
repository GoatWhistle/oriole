name: CI for FastAPI with Docker and pre-commit

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install

    - name: Run pre-commit hooks
      run: pre-commit run --all-files --show-diff-on-failure --color always

    - name: Copy env file for docker-compose
      run: |
        cp src/backend/.env src/backend/.env
        cp src/backend/.env.app_config src/backend/.env.app_config
        cp src/backend/jwt-private.pem src/backend/jwt-private.pem
        cp src/backend/jwt-public.pem src/backend/jwt-public.pem

    - name: Build and start services
      run: docker compose --env-file src/backend/.env up -d --build

    - name: ðŸ’¤ Wait for services to be ready
      run: sleep 90

    - name: Run tests in backend container
      run: docker compose exec -T backend pytest src/tests/

    - name: Tear down containers
      if: always()
      run: docker compose down -v
